<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Game with Ranking</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            letter-spacing: 0; /* ê¸€ì ê°„ê²© ì„¤ì • */
            margin: 0;
            padding: 10px;
        }
        h2, h3, label, button {
            margin: 5px 0;
            padding: 0;
        }
        select, input {
            margin: 5px 0;
            padding: 5px;
        }
        ol {
            margin: 10px 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <h2>í˜„ì¬ ë³´ìœ  ì”ì•¡: <br><span id="balance">10000000</span> KRW</h2>
    <h2>í˜„ì¬ <span id="coin-name">ë¹„íŠ¸ì½”ì¸</span> ê°€ê²©:<br> <span id="coin-price">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span> KRW</h2>
    <h3>ë³´ìœ í•œ <span id="selected-coin">ë¹„íŠ¸ì½”ì¸</span> ìˆ˜ëŸ‰: <span id="coin-holdings">0</span></h3>
    <h3>ë§¤ìˆ˜ ì‹œì  ê¸°ì¤€ ë³€ë™ë¥ : <span id="change-percentage">0</span>%</h3>
    <h3>ì´ ìˆ˜ìµ: <span id="profit">0</span> KRW</h3>

    <label for="coin-select">ì½”ì¸ ì„ íƒ: </label>
    <select id="coin-select">
        <option value="BTC">ë¹„íŠ¸ì½”ì¸</option>
        <option value="DOGE">ë„ì§€ì½”ì¸</option>
        <option value="ETH">ì´ë”ë¦¬ì›€</option>
    </select>

    <br><br>

    <label for="buy-amount">êµ¬ë§¤ ê¸ˆì•¡ (KRW):
    <input type="number" id="buy-amount" placeholder="ê¸ˆì•¡ ì…ë ¥">
    <button id="buy-btn">ë§¤ìˆ˜</button>
    <button id="sell-btn">ëª¨ë‘ ë§¤ë„</button>

    <h2>ğŸ† ì‹¤ì‹œê°„ ë­í‚¹</h2>
    <ol id="ranking-list"></ol>

    <script>
        const balanceElement = document.getElementById("balance");
        const coinPriceElement = document.getElementById("coin-price");
        const coinNameElement = document.getElementById("coin-name");
        const selectedCoinElement = document.getElementById("selected-coin");
        const coinHoldingsElement = document.getElementById("coin-holdings");
        const changePercentageElement = document.getElementById("change-percentage");
        const profitElement = document.getElementById("profit");
        const buyAmountInput = document.getElementById("buy-amount");
        const coinSelect = document.getElementById("coin-select");
        const buyButton = document.getElementById("buy-btn");
        const sellButton = document.getElementById("sell-btn");
        const rankingListElement = document.getElementById("ranking-list");

        let balance = 10000000; // ì´ˆê¸° ì”ì•¡
        let coinPrice = 0; // ì„ íƒí•œ ì½”ì¸ì˜ ê°€ê²©
        let coinHoldings = 0; // ì´ˆê¸° ë³´ìœ  ì½”ì¸
        let purchasePrice = 0; // ì´ˆê¸° ë§¤ìˆ˜ í‰ê· ê°€
        let totalInvestment = 0; // ì´ˆê¸° íˆ¬ì ê¸ˆì•¡
        let playerName = "";

        // ì´ˆê¸°í™”: ì´ë¦„ ì…ë ¥ ë° ë°ì´í„° ì„¤ì •
        function initializeGame() {
            const storedData = JSON.parse(localStorage.getItem("gameData"));
            if (!storedData) {
                // ìƒˆë¡œìš´ ê²Œì„ ì‹œì‘
                playerName = prompt("ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:").trim();
                if (!playerName) {
                    alert("ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
                    return;
                }

                const newGameData = {
                    name: playerName,
                    balance: balance,
                    coinHoldings: coinHoldings,
                    purchasePrice: purchasePrice,
                    totalInvestment: totalInvestment,
                };

                localStorage.setItem("gameData", JSON.stringify(newGameData));
            } else {
                // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                playerName = storedData.name;
                balance = storedData.balance;
                coinHoldings = storedData.coinHoldings;
                purchasePrice = storedData.purchasePrice;
                totalInvestment = storedData.totalInvestment;
            }

            // ë­í‚¹ í‘œì‹œ
            updateRankingList();
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            balanceElement.textContent = balance.toLocaleString();
            coinHoldingsElement.textContent = coinHoldings.toFixed(6);
            if (purchasePrice > 0) {
                const changePercentage = ((coinPrice - purchasePrice) / purchasePrice) * 100;
                const profit = coinHoldings * (coinPrice - purchasePrice);

                changePercentageElement.textContent = changePercentage.toFixed(2);
                profitElement.textContent = profit.toLocaleString();

                // ë­í‚¹ ì—…ë°ì´íŠ¸
                updateRankingList();
            }
        }

        // ë­í‚¹ ë°ì´í„° ì—…ë°ì´íŠ¸ ë° í‘œì‹œ
        function updateRankingList() {
            const rankings = JSON.parse(localStorage.getItem("rankings")) || [];
            const gameData = JSON.parse(localStorage.getItem("gameData"));

            if (gameData) {
                const userRanking = {
                    name: gameData.name,
                    balance: gameData.balance,
                };

                // ë­í‚¹ ë°ì´í„°ì— í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì €ì¥
                const updatedRankings = rankings.filter(r => r.name !== gameData.name); // ê¸°ì¡´ ì‚¬ìš©ì ì‚­ì œ
                updatedRankings.push(userRanking); // í˜„ì¬ ì‚¬ìš©ì ì¶”ê°€
                updatedRankings.sort((a, b) => b.balance - a.balance); // ì”ì•¡ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                localStorage.setItem("rankings", JSON.stringify(updatedRankings));

                // UIì— í‘œì‹œ
                rankingListElement.innerHTML = "";
                updatedRankings.forEach((rank, index) => {
                    const listItem = document.createElement("li");
                    listItem.textContent = `${index + 1}. ${rank.name} - ì”ì•¡: ${rank.balance.toLocaleString()} KRW`;
                    rankingListElement.appendChild(listItem);
                });
            }
        }

        // ì½”ì¸ ê°€ê²© ê°€ì ¸ì˜¤ê¸°
        async function fetchCoinPrice() {
  try {
    const response = await fetch(`/api/upbit?coin=${coinSelect.value}`);
    const data = await response.json();
    if (data && data.length > 0) {
      coinPrice = data[0].trade_price;
      coinPriceElement.textContent = coinPrice.toLocaleString();
      coinNameElement.textContent = coinSelect.options[coinSelect.selectedIndex].text;
      selectedCoinElement.textContent = coinSelect.options[coinSelect.selectedIndex].text;
      updateUI();
    } else {
      throw new Error('ê°€ê²© ë°ì´í„° ì—†ìŒ');
    }
  } catch (error) {
    console.error("ì½”ì¸ ê°€ê²© ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
    coinPriceElement.textContent = "ê°€ê²© ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
  }
}


        // ë§¤ìˆ˜
        buyButton.addEventListener("click", () => {
            const buyAmount = parseFloat(buyAmountInput.value);
            if (isNaN(buyAmount) || buyAmount <= 0 || buyAmount > balance) {
                alert("ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”!");
                return;
            }
            const coinQuantity = buyAmount / coinPrice;
            balance -= buyAmount;
            coinHoldings += coinQuantity;
            totalInvestment += buyAmount;
            purchasePrice = totalInvestment / coinHoldings;

            localStorage.setItem("gameData", JSON.stringify({
                name: playerName,
                balance: balance,
                coinHoldings: coinHoldings,
                purchasePrice: purchasePrice,
                totalInvestment: totalInvestment,
            }));

            updateUI();
            alert(`${coinSelect.options[coinSelect.selectedIndex].text} ${coinQuantity.toFixed(6)} ê°œ ë§¤ìˆ˜ ì™„ë£Œ!`);
        });

        // ë§¤ë„
        sellButton.addEventListener("click", () => {
            if (coinHoldings <= 0) {
                alert("ë§¤ë„í•  ì½”ì¸ì´ ì—†ìŠµë‹ˆë‹¤!");
                return;
            }
            const sellAmount = coinHoldings * coinPrice;
            balance += sellAmount;
            coinHoldings = 0;
            totalInvestment = 0;
            purchasePrice = 0;

            localStorage.setItem("gameData", JSON.stringify({
                name: playerName,
                balance: balance,
                coinHoldings: coinHoldings,
                purchasePrice: purchasePrice,
                totalInvestment: totalInvestment,
            }));

            updateUI();
            alert(`${coinSelect.options[coinSelect.selectedIndex].text} ëª¨ë‘ ë§¤ë„ ì™„ë£Œ!`);
        });

        async function fetchRanking() {
    try {
        const response = await fetch('/api/ranking');
        const rankings = await response.json();

        rankingListElement.innerHTML = '';
        rankings.forEach((rank, index) => {
            const listItem = document.createElement('li');
            listItem.textContent = `${index + 1}. ${rank.name} - ì”ì•¡: ${rank.balance.toLocaleString()} KRW`;
            rankingListElement.appendChild(listItem);
        });
    } catch (error) {
        console.error("ë­í‚¹ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
    }
}

// ê²Œì„ ì¢…ë£Œ í›„ ë­í‚¹ ì—…ë°ì´íŠ¸
async function updateRanking() {
    const gameData = JSON.parse(localStorage.getItem("gameData"));
    if (!gameData) return;

    try {
        const response = await fetch('/api/update-ranking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: gameData.name,
                balance: gameData.balance
            })
        });

        if (response.ok) {
            alert("ë­í‚¹ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
            fetchRanking(); // ë­í‚¹ ì—…ë°ì´íŠ¸ í›„ UI ë°˜ì˜
        } else {
            alert("ë­í‚¹ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
        }
    } catch (error) {
        console.error("ë­í‚¹ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
    }
}

// ë§¤ìˆ˜ ë˜ëŠ” ë§¤ë„ í›„ ë­í‚¹ ì—…ë°ì´íŠ¸
buyButton.addEventListener("click", () => {
    // ë§¤ìˆ˜ ë¡œì§...
    updateRanking();
});

sellButton.addEventListener("click", () => {
    // ë§¤ë„ ë¡œì§...
    updateRanking();
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë­í‚¹ ì—…ë°ì´íŠ¸
window.onload = fetchRanking;

        // ì´ˆê¸°í™”
        initializeGame();
        fetchCoinPrice();
        setInterval(fetchCoinPrice, 500); // 5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    </script>
</body>
</html>
